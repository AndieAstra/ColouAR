<html>

<head>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image.prod.js"></script>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-aframe.prod.js"></script>
  </head>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="capture-video-frame.js"></script>
    <style>
        #photo {
            position: absolute;
            top: 0;
            right: 30px;
            z-index: 5;
            width: 600px;
            height: 400px;
            display: none;
        }

        #foto-button {
            position: absolute;
            top: 0;
            z-index: 5;
        }

        #canvas{
            position: absolute;
            bottom: 0;
            left: 30px;
            z-index: 8;
            width: 300px;
            height: 200px; 
        }
    </style>
</head>

<body>
    <button class="button" id="foto-button">Recognize</button>

    <img id="photo">
    <canvas id="canvas"></canvas>

    <a-scene mindar-image="imageTargetSrc: targets.mind;" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>
        <a-entity mindar-image-target="targetIndex: 0">
            <a-plane id="screenshot" rotation="0 0 0"></a-plane>
          </a-entity>
    </a-scene>
    <!-- Screenshot-->

</body>
<script>
    function resizeCanvas(origCanvas, width, height) {
        let resizedCanvas = document.createElement("canvas");
        let resizedContext = resizedCanvas.getContext("2d");

        resizedCanvas.height = height;
        resizedCanvas.width = width;

        resizedContext.drawImage(origCanvas, 0, 0, width, height);
        return resizedCanvas.toDataURL();
    }

    document.getElementById("foto-button").addEventListener("click", function () {
        let aScene = document.querySelector("a-scene").components.screenshot.getCanvas("perspective");
        let frame = captureVideoFrame("video", "png");
        aScene = resizeCanvas(aScene, frame.width, frame.height);
        frame = frame.dataUri;
        console.log("success");

        //Show photo as texture
        let image = document.getElementById("photo");
        image.setAttribute('src', frame);
        // let screenshot = document.querySelector("#screenshot");
        // screenshot.setAttribute("material", "src:");  
        // screenshot.setAttribute("material", "src:#photo");  
        setTimeout(() => {
            removeColor();
        }, 3000);
        
        //handwritingOCR(frame)

    });

    function captureVideoFrame(video, format, width, height) {
        if (typeof video === 'string') {
            video = document.querySelector(video);
        }
        format = format || 'jpeg';

        if (!video || (format !== 'png' && format !== 'jpeg')) {
            return false;
        }
        var canvas = document.createElement("CANVAS");
        canvas.width = width || video.videoWidth;
        canvas.height = height || video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        var dataUri = canvas.toDataURL('image/' + format);
        var data = dataUri.split(',')[1];
        var mimeType = dataUri.split(';')[0].slice(5)

        var bytes = window.atob(data);
        var buf = new ArrayBuffer(bytes.length);
        var arr = new Uint8Array(buf);

        for (var i = 0; i < bytes.length; i++) {
            arr[i] = bytes.charCodeAt(i);
        }
        var blob = new Blob([arr], { type: mimeType });
        return { blob: blob, dataUri: dataUri, format: format, width: canvas.width, height: canvas.height };
    };


    // function handwritingOCR(frame) {
    //     fetch('https://hf.space/embed/Akbartus/handwritingOCR/+/api/predict/', {
    //         method: "POST", body: JSON.stringify({
    //             "data": ["data:" + frame]
    //         }),
    //         headers: { "Content-Type": "application/json" }
    //     }).then(
    //         function (response) {
    //             return response.json();
    //         })
    //         .then(function (json_response) {
    //             console.log(json_response)
    //         })
    // }

    function removeColor() {
        var canvas = document.getElementById("canvas"),
            ctx = canvas.getContext("2d"),
            image = document.getElementById("photo");
 
        canvas.width = image.width;
        canvas.height = image.height;
        ctx.drawImage(image, 0, 0);

        var imgd = ctx.getImageData(0, 0, image.width, image.height),
            pix = imgd.data,
            newColor = {r:0,g:0,b:0,a:0};

        for (var i = 0, n = pix.length; i < n; i += 4) {
            var r = pix[i],
                g = pix[i + 1],
                b = pix[i + 2];
               
            if (r > 100 && g > 100 && b > 100) {
                // Change the white to the new color.
                pix[i] = newColor.r;
                pix[i + 1] = newColor.g;
                pix[i + 2] = newColor.b;
                pix[i+3] = newColor.a;
                
            }
        }

        ctx.putImageData(imgd, 0, 0);

       let screenshot = document.querySelector("#screenshot");
        screenshot.setAttribute("material", "src:");  
        screenshot.setAttribute("material", "src:#canvas");  
    }
</script>

</html>